<!doctype html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

    <script>
      // Register the videohandler component
      AFRAME.registerComponent('videohandler', {
        schema: {
          target: { type: 'selector' }
        },
        init: function () {
          const marker = this.el;
          const video = this.data.target;

          marker.addEventListener('markerFound', () => video.play());
          marker.addEventListener('markerLost', () => video.pause());
        }
      });

      // Load markers and videos from JSON dynamically
      document.addEventListener('DOMContentLoaded', () => {
        fetch('assets/markers.json') // JSON should be in public folder or same directory
          .then(response => response.json())
          .then(data => {
            const scene = document.querySelector('#scene');
            const assets = document.querySelector('a-assets');

            data.forEach((item, index) => {
              const videoId = `vid_${index}`;

              // Create video asset
              const video = document.createElement('video');
              video.setAttribute('id', videoId);
              video.setAttribute('src', item.videoUrl);
              video.setAttribute('loop', '');
              video.setAttribute('preload', 'auto');
              video.setAttribute('crossorigin', 'anonymous');
              video.setAttribute('webkit-playsinline', '');
              video.setAttribute('playsinline', '');
              video.setAttribute('muted', '');
              assets.appendChild(video);

              // Create marker
              const marker = document.createElement('a-marker');
              marker.setAttribute('type', 'pattern');
              marker.setAttribute('preset', 'custom');
              marker.setAttribute('url', item.markerUrl);
              marker.setAttribute('videohandler', `target: #${videoId}`);
              marker.setAttribute('gesture-detector', '');
              marker.setAttribute('smooth', 'true');
              marker.setAttribute('smoothCount', '10');
              marker.setAttribute('smoothTolerance', '0.01');
              marker.setAttribute('smoothThreshold', '5');
              marker.setAttribute('raycaster', 'objects: .clickable');
              marker.setAttribute('emitevents', 'true');
              marker.setAttribute('cursor', 'fuse: false; rayOrigin: mouse;');
              marker.setAttribute('id', `marker_${index}`);

              // Create a-video inside marker
              const aVideo = document.createElement('a-video');
              aVideo.setAttribute('src', `#${videoId}`);
              aVideo.setAttribute('scale', '1 1 1');
              aVideo.setAttribute('position', '0 0.1 0');
              aVideo.setAttribute('rotation', '-90 0 0');
              aVideo.setAttribute('class', 'clickable');
              aVideo.setAttribute('gesture-handler', '');

              marker.appendChild(aVideo);
              scene.appendChild(marker);
            });
          });
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      loading-screen="enabled: false;"
      arjs='sourceType: webcam; debugUIEnabled: false;'
      id="scene"
      embedded
      gesture-detector
    >
      <a-assets></a-assets>
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
